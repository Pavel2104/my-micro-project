name: CI Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      # Сервис базы данных
      db_orders:
        image: postgres:15
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: orders_db
        ports:
          - 5432:5432
        # Ждем, пока Postgres станет доступен
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      # Сервис Kafka
      kafka:
        image: apache/kafka:3.7.1
        ports:
          - 9092:9092
        env:
          KAFKA_NODE_ID: 1
          KAFKA_PROCESS_ROLES: broker,controller
          KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
          KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
          KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
          KAFKA_CONTROLLER_QUORUM_VOTERS: 1@localhost:9093
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
          KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
          KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio httpx sqlalchemy aiokafka asyncpg fastapi uvicorn celery passlib pydantic-settings psycopg2-binary
          if [ -f api_gateway/requirements.txt ]; then pip install -r api_gateway/requirements.txt; fi

      - name: Wait for Kafka
        run: |
          echo "Waiting for Kafka port..."
          timeout 60s bash -c 'until printf "" 2>>/dev/null >>/dev/tcp/localhost/9092; do sleep 2; done'
          echo "Kafka port is open, waiting for metadata initialization..."
          sleep 15

      - name: Create Kafka Topic
        run: |
          # Создаем именно тот топик, который ищет твой код
          docker exec $(docker ps -q --filter ancestor=apache/kafka:3.7.1) \
          /opt/kafka/bin/kafka-topics.sh --create --topic orders_new --bootstrap-server localhost:9092 --partitions 1 --replication-factor 1 || true
          echo "Topic 'orders_new' check/creation complete."

      - name: Run Tests
        env:
          # Переопределяем адреса на localhost для среды GitHub Actions
          KAFKA_BOOTSTRAP_SERVERS: localhost:9092
          DATABASE_URL: postgresql://user:password@localhost:5432/orders_db
          PYTHONPATH: ${{ github.workspace }}/api_gateway
        run: |
          # Запускаем тесты с ограничением по времени, чтобы не висели вечно
          pytest api_gateway/tests/ -v --maxfail=1




