name: CI Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      kafka:
        image: bitnami/kafka:3.4.0
        ports:
          - 9092:9092
        env:
          KAFKA_ENABLE_KRAFT: yes
          KAFKA_CFG_PROCESS_ROLES: broker,controller
          KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
          KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
          KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
          KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://127.0.0.1:9092
          KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@127.0.0.1:9093
          KAFKA_CFG_NODE_ID: 1
          ALLOW_PLAINTEXT_LISTENER: yes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install All Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-asyncio httpx sqlalchemy aiokafka asyncpg fastapi uvicorn celery passlib pydantic-settings
          # Установка зависимостей из requirements, если они есть
          find . -name "requirements.txt" -exec pip install -r {} +

      - name: Wait for Kafka
        # Ждем, пока порт 9092 станет доступен (максимум 60 секунд)
        run: |
          echo "Waiting for Kafka to start..."
          timeout 60s bash -c 'until printf "" 2>>/dev/null >>/dev/tcp/localhost/9092; do sleep 2; done'
          echo "Kafka is ready!"
          sleep 5

      - name: Run Tests
        env:
          # Передаем адрес Kafka в тесты через переменную окружения
          KAFKA_BOOTSTRAP_SERVERS: localhost:9092
          PYTHONPATH: ${{ github.workspace }}/api_gateway
        run: |
          pytest api_gateway/tests/ -v

